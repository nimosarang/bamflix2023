<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>íšŒì›ê°€ì…</title>

  <link rel="stylesheet" th:href="@{/css/index/css/bootstrap.min.css}"/>
  <link rel="stylesheet" th:href="@{/css/index/css/signup-style.css}"/>
</head>

<body>
<main class="container-fluid">
  <!---->
  <section id="backGround">
    <div class="container-fluid relative">
      <header>
        <img th:src="@{/css/index/img/bamflix_img.png}" alt="Responsive image LOGO"
             class="img-fluid"/>
      </header>
    </div>
    <div class="jumbotron jumbotron-fluid relative mt-5">
      <h1>Welcome to ğŸŒ°flix</h1>
      <p class="lead">ë°¤í”Œë¦­ìŠ¤ëŠ” 1ì¸ ì‹œì²­ìë¥¼ ìœ„í•œ ì°©í•œ ê³³</p>
    </div>
  </section>

  <div class="main">
    <div class="container">
      <h2 class="title">íšŒì›ê°€ì…</h2>
      <p class="description">
        ì›í™œí•œ ì„œë¹„ìŠ¤ë¥¼ ì´ìš©ì„ ìœ„í•´ íšŒì›ê°€ì…ì„ í•´ì£¼ì„¸ìš”
      </p>

      <form class="login" onsubmit="return saveMember(this);">
        <div class="form-group">
          <input type="text" id="user-id" name="loginId" class="form-control" placeholder="ì•„ì´ë””" required>
          <button type="button" id="idCheckBtn" class="btn btn-primary" onclick="checkLoginId();">ì¤‘ë³µ
            í™•ì¸
          </button>
        </div>

        <div class="form-group">
          <input type="password" id="user-pw" name="password" class="form-control" placeholder="ë¹„ë°€ë²ˆí˜¸" required >
        </div>

        <div class="form-group">
          <input type="password" id="user-pw-check" name="passwordCheck" placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸" class="form-control"
                 required>
        </div>

        <div class="form-group">
          <input type="text" id="user-name" name="name" class="form-control" placeholder="ì´ë¦„" required>
        </div>

        <div class="form-group">
          <input type="email" id="user-email" name="email" class="form-control" placeholder="ì´ë©”ì¼" required>
        </div>

        <div class="form-group">
          <input type="text" id="user-phone" name="phone" class="form-control" placeholder="íœ´ëŒ€í°ë²ˆí˜¸" required>
        </div>

        <div class="form-group">
          <input type="number" id="user-birth" name="birthday" class="form-control"
                 placeholder="ìƒë…„ì›”ì¼ : ìˆ«ì 8ìë¦¬ ì…ë ¥"/>
        </div>

        <div class="form-group">
          <label class="form-check-label" for="gender1">ë‚¨ì„±</label>
          <input type="radio" name="gender" id="gender1" value="M">
          <label class="form-check-label" for="gender2">ì—¬ì„±</label>
          <input type="radio" name="gender" id="gender2" value="F">
        </div>

        <button class="btn btn-primary submit-button" type="submit">íšŒì›ê°€ì…</button>
      </form>

    </div>
  </div>
</main>

<script th:src="@{/index/js/main.js/}"></script>
<script th:src="@{/index/js/bootstrap.bundle.min.js/}"></script>
<script th:src="@{/js/function.js}"></script>
<script th:src="@{/js/jquery-3.6.0.min.js}"></script>
<script>

  // ì•„ì´ë”” ì¤‘ë³µ ì²´í¬
  async function checkLoginId() {
    const loginId = document.querySelector('#user-id');
    if (!isValid(loginId, 'ì•„ì´ë””')) {
      return false;
    }

    const count = await getJson(`/member-count?loginId=${loginId.value}`);

    if (count > 0) {
      alert('ì´ë¯¸ ê°€ì…ëœ ì•„ì´ë””ê°€ ìˆìŠµë‹ˆë‹¤.');
      loginId.focus();
      return false;
    }

    if (confirm('ì‚¬ìš© ê°€ëŠ¥í•œ ì•„ì´ë””ì…ë‹ˆë‹¤.\nì…ë ¥í•˜ì‹  ì•„ì´ë””ë¡œ ê²°ì •í•˜ì‹œê² ì–´ìš”?')) {
      loginId.readOnly = true;
      document.getElementById('idCheckBtn').disabled = true;
    }
  }

  // íšŒì› ì •ë³´ ìœ íš¨ì„± ê²€ì‚¬
  function validationMemberInfo(form) {
    const fields = form.querySelectorAll('input:not([type="radio"])');
    const fieldNames = ['loginId', 'password', 'passwordCheck', 'name', 'birthday'];

    for (let i = 0; i < fields.length; i++) {
      if (!isValid(fields[i], fieldNames[i])) {
        return false;
      }
    }

    if (form.querySelector('input[name="loginId"]').readOnly === false) {
      alert('ì•„ì´ë”” ì¤‘ë³µ ì²´í¬ë¥¼ ì™„ë£Œí•´ ì£¼ì„¸ìš”.');
      return false;
    }

    const password = form.querySelector('input[name="password"]').value;
    const passwordCheck = form.querySelector('input[name="passwordCheck"]').value;

    if (password !== passwordCheck) {
      alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
      form.querySelector('input[name="passwordCheck"]').focus();
      return false;
    }

    return true; // ìœ íš¨ì„± ê²€ì‚¬ í†µê³¼
  }

  // íšŒì› ì •ë³´ ì €ì¥ (íšŒì›ê°€ì…)
  function saveMember(form) {
    event.preventDefault();

    // í•„ë“œ ìœ íš¨ì„± ê²€ì‚¬
    if (!validationMemberInfo(event.target)) {
      return;
    }

    // íŒŒë¼ë¯¸í„° ì„¸íŒ…
    form = event.target;
    const params = {};
    new FormData(form).forEach((value, key) => (params[key] = value.trim()));
    params.birthday = params.birthday.replace(/(\d{4})(\d{2})(\d{2})/g, '$1-$2-$3');

    callApi('/members', 'post', params, handleSignupSuccess);
  }

  // íšŒì›ê°€ì… ì„±ê³µ ì‹œ ì‹¤í–‰ë  ì½œë°± í•¨ìˆ˜
  function handleSignupSuccess(data) {
    alert('ê°€ì…ì„ ì¶•í•˜ë“œë¦½ë‹ˆë‹¤!\në¡œê·¸ì¸ í›„ ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•´ ì£¼ì„¸ìš”.');
    window.location.replace('/login');
  }

</script>

</body>

</html>